local Library = {
    Flags = {},
    Elements = {}, -- Tracks UI elements so they can be updated
    Theme = {
        Accent = Color3.fromRGB(80, 120, 255),
        Background = Color3.fromRGB(15, 15, 20),
        Text = Color3.fromRGB(255, 255, 255),
        Secondary = Color3.fromRGB(45, 45, 50)
    },
    ToggleKey = Enum.KeyCode.RightShift,
    Opened = true,
    Notifications = nil
}

local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local player = Players.LocalPlayer

-- Helper: Glass Styling
local function applyGlassEffect(guiObject, radius, transparency, strokeTransparency)
    guiObject.BackgroundColor3 = Library.Theme.Background
    guiObject.BackgroundTransparency = transparency or 0.4
    guiObject.BorderSizePixel = 0
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, radius or 8)
    corner.Parent = guiObject
    
    if strokeTransparency then
        local stroke = Instance.new("UIStroke")
        stroke.Color = Color3.fromRGB(255, 255, 255)
        stroke.Transparency = strokeTransparency
        stroke.Thickness = 1
        stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
        stroke.Parent = guiObject
    end
end

-- Update System: Updates a specific flag or ALL flags
function Library:Update(targetFlag)
    local function refresh(flag)
        local data = self.Elements[flag]
        if not data then return end
        
        if data.Type == "Toggle" then
            data.Indicator.BackgroundColor3 = self.Flags[flag] and self.Theme.Accent or self.Theme.Secondary
        elseif data.Type == "Dropdown" then
            data.Button.Text = "   " .. data.Title .. " : " .. tostring(self.Flags[flag])
        elseif data.Type == "Keybind" then
            data.Label.Text = tostring(self.Flags[flag])
        elseif data.Type == "TextBox" then
            data.Box.Text = tostring(self.Flags[flag])
        end
    end

    if targetFlag then
        refresh(targetFlag) -- Update only one specific UI element
    else
        for flag, _ in pairs(self.Elements) do
            refresh(flag) -- Update everything
        end
    end
end

-- Notification System
function Library:Notify(title, content, duration)
    if not self.Notifications then
        local NotifyGui = Instance.new("ScreenGui")
        NotifyGui.Name = "LiquidNotifications"
        NotifyGui.Parent = player:WaitForChild("PlayerGui")
        
        local Holder = Instance.new("Frame")
        Holder.Size = UDim2.new(0, 300, 1, -20)
        Holder.Position = UDim2.new(1, -310, 0, 10)
        Holder.BackgroundTransparency = 1
        Holder.Parent = NotifyGui
        
        local List = Instance.new("UIListLayout")
        List.VerticalAlignment = Enum.VerticalAlignment.Bottom
        List.Padding = UDim.new(0, 10)
        List.Parent = Holder
        self.Notifications = Holder
    end
    
    local Notif = Instance.new("Frame")
    Notif.Size = UDim2.new(1, 0, 0, 80)
    Notif.ClipsDescendants = true
    applyGlassEffect(Notif, 8, 0.2, 0.7)
    Notif.Parent = self.Notifications
    
    local T = Instance.new("TextLabel")
    T.Size = UDim2.new(1, -10, 0, 25)
    T.Position = UDim2.new(0, 10, 0, 5)
    T.Text = title
    T.Font = Enum.Font.GothamBold
    T.TextColor3 = Library.Theme.Accent
    T.TextSize = 14
    T.TextXAlignment = Enum.TextXAlignment.Left
    T.BackgroundTransparency = 1
    T.Parent = Notif
    
    local B = Instance.new("TextLabel")
    B.Size = UDim2.new(1, -20, 0, 45)
    B.Position = UDim2.new(0, 10, 0, 25)
    B.Text = content
    B.Font = Enum.Font.Gotham
    B.TextColor3 = Library.Theme.Text
    B.TextSize = 13
    B.TextWrapped = true
    B.TextXAlignment = Enum.TextXAlignment.Left
    B.BackgroundTransparency = 1
    B.Parent = Notif

    task.delay(duration or 5, function()
        TweenService:Create(Notif, TweenInfo.new(0.5), {BackgroundTransparency = 1}):Play()
        TweenService:Create(T, TweenInfo.new(0.5), {TextTransparency = 1}):Play()
        TweenService:Create(B, TweenInfo.new(0.5), {TextTransparency = 1}):Play()
        task.wait(0.5)
        Notif:Destroy()
    end)
end

function Library:CreateWindow(title)
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "LiquidUI"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = player:WaitForChild("PlayerGui")
    self.ScreenGui = ScreenGui

    -- UI Toggle
    UserInputService.InputBegan:Connect(function(input, gpe)
        if not gpe and input.KeyCode == self.ToggleKey then
            self.Opened = not self.Opened
            ScreenGui.Enabled = self.Opened
        end
    end)

    local Main = Instance.new("Frame")
    Main.Name = "Main"
    Main.Size = UDim2.new(0, 650, 0, 500) -- INCREASED UI SIZE
    Main.Position = UDim2.new(0.5, -325, 0.5, -250)
    applyGlassEffect(Main, 12, 0.2, 0.6)
    Main.Parent = ScreenGui

    -- Dragging
    local dragging, dragStart, startPos
    Main.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true; dragStart = input.Position; startPos = Main.Position
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
            local delta = input.Position - dragStart
            Main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
    end)

    local TopBar = Instance.new("Frame")
    TopBar.Size = UDim2.new(1, 0, 0, 45)
    applyGlassEffect(TopBar, 12, 0.4, nil)
    TopBar.Parent = Main

    local Title = Instance.new("TextLabel")
    Title.Text = "  " .. (title or "Liquid Library")
    Title.Size = UDim2.new(1, 0, 1, 0)
    Title.BackgroundTransparency = 1
    Title.TextColor3 = Library.Theme.Text
    Title.Font = Enum.Font.GothamBold
    Title.TextSize = 18
    Title.TextXAlignment = Enum.TextXAlignment.Left
    Title.Parent = TopBar

    local TabScroll = Instance.new("ScrollingFrame")
    TabScroll.Size = UDim2.new(0, 150, 1, -55)
    TabScroll.Position = UDim2.new(0, 8, 0, 50)
    TabScroll.BackgroundTransparency = 1
    TabScroll.ScrollBarThickness = 0
    TabScroll.Parent = Main
    Instance.new("UIListLayout", TabScroll).Padding = UDim.new(0, 5)

    local PageContainer = Instance.new("Frame")
    PageContainer.Size = UDim2.new(1, -175, 1, -55)
    PageContainer.Position = UDim2.new(0, 165, 0, 50)
    PageContainer.BackgroundTransparency = 1
    PageContainer.Parent = Main

    local Window = { CurrentTab = nil }

    function Window:CreateTab(name)
        local TabBtn = Instance.new("TextButton")
        TabBtn.Size = UDim2.new(1, -5, 0, 40)
        TabBtn.Text = name
        TabBtn.TextColor3 = Library.Theme.Text
        TabBtn.Font = Enum.Font.GothamSemibold
        TabBtn.TextSize = 14
        applyGlassEffect(TabBtn, 6, 0.6, 0.8)
        TabBtn.Parent = TabScroll

        local Page = Instance.new("ScrollingFrame")
        Page.Size = UDim2.new(1, 0, 1, 0)
        Page.Visible = false
        Page.BackgroundTransparency = 1
        Page.ScrollBarThickness = 2
        Page.ScrollBarImageColor3 = Library.Theme.Accent
        Page.Parent = PageContainer

        local PageList = Instance.new("UIListLayout")
        PageList.Padding = UDim.new(0, 8)
        PageList.HorizontalAlignment = Enum.HorizontalAlignment.Center
        PageList.Parent = Page
        
        PageList:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            Page.CanvasSize = UDim2.new(0, 0, 0, PageList.AbsoluteContentSize.Y + 20)
        end)

        TabBtn.MouseButton1Click:Connect(function()
            for _, p in pairs(PageContainer:GetChildren()) do p.Visible = false end
            for _, b in pairs(TabScroll:GetChildren()) do 
                if b:IsA("TextButton") then b.BackgroundColor3 = Library.Theme.Background end
            end
            Page.Visible = true
            TabBtn.BackgroundColor3 = Library.Theme.Accent
        end)

        if not Window.CurrentTab then
            Page.Visible = true
            TabBtn.BackgroundColor3 = Library.Theme.Accent
            Window.CurrentTab = name
        end

        local Elements = {}

        function Elements:CreateButton(text, callback)
            local Btn = Instance.new("TextButton")
            Btn.Size = UDim2.new(1, -10, 0, 45)
            Btn.Text = text
            Btn.Font = Enum.Font.Gotham
            Btn.TextColor3 = Library.Theme.Text
            Btn.TextSize = 14
            applyGlassEffect(Btn, 6, 0.5, 0.7)
            Btn.Parent = Page
            Btn.MouseButton1Click:Connect(callback)
        end

        function Elements:CreateTextBox(text, flag, default, callback)
            Library.Flags[flag] = default or ""
            local BoxFrame = Instance.new("Frame")
            BoxFrame.Size = UDim2.new(1, -10, 0, 45)
            applyGlassEffect(BoxFrame, 6, 0.5, 0.7)
            BoxFrame.Parent = Page

            local Box = Instance.new("TextBox")
            Box.Size = UDim2.new(1, -20, 1, 0)
            Box.Position = UDim2.new(0, 10, 0, 0)
            Box.BackgroundTransparency = 1
            Box.Text = Library.Flags[flag]
            Box.PlaceholderText = text
            Box.Font = Enum.Font.Gotham
            Box.TextColor3 = Library.Theme.Text
            Box.TextSize = 14
            Box.TextXAlignment = Enum.TextXAlignment.Left
            Box.Parent = BoxFrame

            -- Register for update system
            Library.Elements[flag] = {Type = "TextBox", Box = Box}

            Box.FocusLost:Connect(function()
                Library.Flags[flag] = Box.Text
                if callback then callback(Box.Text) end
            end)
        end

        function Elements:CreateToggle(text, flag, default, callback)
            Library.Flags[flag] = default or false
            local Toggle = Instance.new("TextButton")
            Toggle.Size = UDim2.new(1, -10, 0, 45)
            Toggle.Text = "   " .. text
            Toggle.Font = Enum.Font.Gotham
            Toggle.TextColor3 = Library.Theme.Text
            Toggle.TextSize = 14
            Toggle.TextXAlignment = Enum.TextXAlignment.Left
            applyGlassEffect(Toggle, 6, 0.5, 0.7)
            Toggle.Parent = Page

            local Ind = Instance.new("Frame")
            Ind.Size = UDim2.new(0, 24, 0, 24)
            Ind.Position = UDim2.new(1, -34, 0.5, -12)
            applyGlassEffect(Ind, 4, 0.2, 0.5)
            Ind.BackgroundColor3 = Library.Flags[flag] and Library.Theme.Accent or Library.Theme.Secondary
            Ind.Parent = Toggle

            -- Register for update system
            Library.Elements[flag] = {Type = "Toggle", Indicator = Ind}

            Toggle.MouseButton1Click:Connect(function()
                Library.Flags[flag] = not Library.Flags[flag]
                Library:Update(flag) -- Use update function
                if callback then callback(Library.Flags[flag]) end
            end)
        end

        function Elements:CreateKeybind(text, flag, default, callback)
            Library.Flags[flag] = default.Name
            local binding = false
            local Bind = Instance.new("TextButton")
            Bind.Size = UDim2.new(1, -10, 0, 45)
            Bind.Text = "   " .. text
            Bind.Font = Enum.Font.Gotham
            Bind.TextColor3 = Library.Theme.Text
            Bind.TextSize = 14
            Bind.TextXAlignment = Enum.TextXAlignment.Left
            applyGlassEffect(Bind, 6, 0.5, 0.7)
            Bind.Parent = Page

            local Lbl = Instance.new("TextLabel")
            Lbl.Size = UDim2.new(0, 80, 0, 26)
            Lbl.Position = UDim2.new(1, -90, 0.5, -13)
            Lbl.Text = Library.Flags[flag]
            Lbl.Font = Enum.Font.GothamBold
            Lbl.TextColor3 = Library.Theme.Accent
            applyGlassEffect(Lbl, 4, 0.3, 0.5)
            Lbl.Parent = Bind

            -- Register for update system
            Library.Elements[flag] = {Type = "Keybind", Label = Lbl}

            Bind.MouseButton1Click:Connect(function()
                binding = true
                Lbl.Text = "..."
            end)

            UserInputService.InputBegan:Connect(function(input)
                if binding and input.UserInputType == Enum.UserInputType.Keyboard then
                    Library.Flags[flag] = input.KeyCode.Name
                    Library:Update(flag) -- Use update function
                    binding = false
                elseif not binding and input.KeyCode.Name == Library.Flags[flag] then
                    if callback then callback() end
                end
            end)
        end

        function Elements:CreateDropdown(text, flag, list, callback)
            Library.Flags[flag] = list[1]
            local itemHeight = 35 -- INCREASED DROPDOWN HEIGHT

            local Drop = Instance.new("Frame")
            Drop.Size = UDim2.new(1, -10, 0, 45)
            Drop.ClipsDescendants = true
            applyGlassEffect(Drop, 6, 0.5, 0.7)
            Drop.Parent = Page

            local Btn = Instance.new("TextButton")
            Btn.Size = UDim2.new(1, 0, 0, 45)
            Btn.Text = "   " .. text .. " : " .. Library.Flags[flag]
            Btn.Font = Enum.Font.Gotham
            Btn.TextColor3 = Library.Theme.Text
            Btn.TextSize = 14
            Btn.BackgroundTransparency = 1
            Btn.TextXAlignment = Enum.TextXAlignment.Left
            Btn.Parent = Drop

            local Container = Instance.new("Frame")
            Container.Size = UDim2.new(1, 0, 0, #list * itemHeight)
            Container.Position = UDim2.new(0, 0, 0, 45)
            Container.BackgroundTransparency = 1
            Container.Parent = Drop
            Instance.new("UIListLayout", Container)

            -- Register for update system
            Library.Elements[flag] = {Type = "Dropdown", Button = Btn, Title = text}

            local open = false
            Btn.MouseButton1Click:Connect(function()
                open = not open
                Drop.Size = open and UDim2.new(1, -10, 0, 45 + (#list * itemHeight)) or UDim2.new(1, -10, 0, 45)
                Page.CanvasSize = UDim2.new(0, 0, 0, PageList.AbsoluteContentSize.Y + 20)
            end)

            for _, v in pairs(list) do
                local Item = Instance.new("TextButton")
                Item.Size = UDim2.new(1, 0, 0, itemHeight)
                Item.Text = v
                Item.Font = Enum.Font.Gotham
                Item.TextColor3 = Color3.fromRGB(180, 180, 180)
                Item.BackgroundTransparency = 1
                Item.Parent = Container
                Item.MouseButton1Click:Connect(function()
                    Library.Flags[flag] = v
                    Library:Update(flag) -- Use update function
                    open = false
                    Drop.Size = UDim2.new(1, -10, 0, 45)
                    if callback then callback(v) end
                end)
            end
        end

        return Elements
    end

    function Window:CreateConfigTab()
        local Tab = self:CreateTab("Settings")
        
        -- Cleanly integrated the Textbox using our new function
        Tab:CreateTextBox("Config Name...", "ConfigName", "DefaultConfig")

        Tab:CreateButton("Save Config", function()
            if writefile then
                local name = Library.Flags["ConfigName"] .. ".json"
                writefile(name, HttpService:JSONEncode(Library.Flags))
                Library:Notify("Config", "Saved to " .. name, 3)
            else
                Library:Notify("Error", "Your executor does not support writefile.", 3)
            end
        end)

        Tab:CreateButton("Load Config", function()
            local name = Library.Flags["ConfigName"] .. ".json"
            if isfile and isfile(name) then
                local success, result = pcall(function()
                    return HttpService:JSONDecode(readfile(name))
                end)
                
                if success and type(result) == "table" then
                    -- Overwrite current flags with loaded data
                    for key, val in pairs(result) do
                        Library.Flags[key] = val
                    end
                    
                    -- UPDATE ALL UI ELEMENTS AT ONCE
                    Library:Update() 
                    
                    Library:Notify("Config", "Successfully loaded " .. name, 3)
                else
                    Library:Notify("Error", "Failed to parse config file.", 3)
                end
            else
                Library:Notify("Error", "File not found!", 3)
            end
        end)

        Tab:CreateButton("Destroy UI", function()
            Library.ScreenGui:Destroy()
            if Library.Notifications then Library.Notifications.Parent:Destroy() end
        end)
    end

    return Window
end

return Library
